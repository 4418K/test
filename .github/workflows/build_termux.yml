name: Build for Termux (Fixed StaticX)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_final:
    runs-on: ubuntu-latest
    name: Build ELF on Alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          run: |
            echo "ğŸ”¥ 1. Installing System Dependencies..."
            apk update
            # å®‰è£… patchelf, gcc, make, binutils ç­‰åŸºç¡€å·¥å…·
            # æ³¨æ„ï¼šä¸ä½¿ç”¨ apk å®‰è£… sconsï¼Œé¿å…ç‰ˆæœ¬å†²çªï¼Œç»Ÿä¸€ç”¨ pip ç®¡ç†
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev libffi-dev make build-base patchelf binutils

            echo "ğŸ“¦ 2. Installing Build Dependencies..."
            # å…ˆå•ç‹¬å®‰è£… scons
            pip3 install scons --break-system-packages

            echo "ğŸ“¦ 3. Installing StaticX (THE FIX)..."
            # ã€å…³é”®ä¿®æ”¹ã€‘åŠ å…¥ --no-build-isolation
            # è¿™æ ·å®‰è£… staticx æ—¶å°±èƒ½æ‰¾åˆ°ä¸Šé¢å®‰è£…çš„ scons äº†
            pip3 install staticx --no-build-isolation --break-system-packages

            echo "ğŸ“¦ 4. Installing Nuitka..."
            pip3 install nuitka --break-system-packages

            echo "ğŸš€ 5. Nuitka Compilation (Phase 1)..."
            # ç¼–è¯‘ Python -> C -> ç‹¬ç«‹æ–‡ä»¶å¤¹
            # æ­¤æ—¶æºä»£ç å·²è¢«ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ .so æ–‡ä»¶
            python3 -m nuitka --standalone --output-dir=build_out pppppp.py

            echo "ğŸ”® 6. StaticX Packaging (Phase 2)..."
            # ä½¿ç”¨ StaticX æ‰“åŒ…æˆå•æ–‡ä»¶ ELF
            # strip èƒ½å¤Ÿå‡å°ä½“ç§¯å¹¶ç§»é™¤è°ƒè¯•ç¬¦å·ï¼ˆå¢åŠ é€†å‘éš¾åº¦ï¼‰
            cd build_out
            staticx --strip main.dist/main.bin final_app

            echo "âœ… Build finished."
            # éªŒè¯ç»“æœ
            ls -lh final_app
            file final_app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_elf_v2
          path: build_out/final_app
