name: Build Termux ELF (StaticX)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-staticx-binary:
    runs-on: ubuntu-latest
    name: Build via StaticX
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Build in QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          # 挂载根目录
          run: |
            echo "--- 1. 安装基础环境 (Alpine) ---"
            # 只需要安装普通的 python3 (动态库)，这几秒钟就能装好
            apk update
            apk add python3 python3-dev py3-pip build-base patchelf scons libffi-dev zlib-dev openssl-dev
            
            echo "--- 2. 安装构建工具 ---"
            # 安装 Nuitka 和 StaticX
            pip3 install nuitka staticx --break-system-packages

            echo "--- 3. Nuitka 初步编译 (生成动态链接程序) ---"
            # 这里不使用 --static-libpython=yes，因为我们用系统的动态库
            python3 -m nuitka \
              --standalone \
              --onefile \
              --output-dir=dist \
              --output-filename=paktool_dynamic \
              A_Main_new.py
            
            echo "验证中间产物..."
            file dist/paktool_dynamic
            # 此时这个文件在 Termux 上运行会报错缺库，所以我们需要下一步
            
            echo "--- 4. 使用 StaticX 打包系统库 ---"
            # StaticX 会把所有依赖的 .so 文件（包括 python 和 musl）全部卷进 exe 里
            # --strip 用于减小体积
            staticx --strip dist/paktool_dynamic dist/paktool
            
            echo "--- 5. 验证最终结果 ---"
            ls -lh dist/paktool
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-aarch64
          path: dist/paktool
          compression-level: 0
