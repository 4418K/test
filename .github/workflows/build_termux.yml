name: Build for Termux (Final ELF)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_elf:
    runs-on: ubuntu-latest
    name: Build ELF on Alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          run: |
            echo "ğŸ”¥ 1. Installing System Dependencies..."
            apk update
            # å®‰è£… patchelf, gcc, make ç­‰åŸºç¡€å·¥å…·
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev libffi-dev make build-base patchelf

            echo "ğŸ“¦ 2. Installing Build Tools (Fixing StaticX Error)..."
            # ã€å…³é”®ä¿®å¤ã€‘æ˜¾å¼å®‰è£… sconsï¼Œè¿™æ˜¯ StaticX ç¼–è¯‘å¤±è´¥çš„æ ¹æº
            pip3 install scons --break-system-packages

            echo "ğŸ“¦ 3. Installing Nuitka and StaticX..."
            # ç°åœ¨å†å®‰è£… staticx å°±ä¸ä¼šæŠ¥é”™äº†
            pip3 install nuitka staticx --break-system-packages

            echo "ğŸš€ 4. Nuitka Compilation (Phase 1)..."
            # ç¬¬ä¸€æ­¥ï¼šNuitka ç¼–è¯‘ Python -> C -> ç‹¬ç«‹æ–‡ä»¶å¤¹
            # æ­¤æ—¶æºä»£ç å·²è¢«ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ .so æ–‡ä»¶ï¼Œä¸å†æ˜¯ .py
            # --standalone: åŒ…å«æ‰€æœ‰ä¾èµ–
            python3 -m nuitka --standalone --output-dir=build_out main.py

            echo "ğŸ”® 5. StaticX Packaging (Phase 2)..."
            # ç¬¬äºŒæ­¥ï¼šStaticX å°†æ–‡ä»¶å¤¹æ‰“åŒ…ä¸ºå•ä¸ª ELF äºŒè¿›åˆ¶
            # å®ƒä¼šè‡ªåŠ¨å¤„ç† musl åº“çš„è·¯å¾„é—®é¢˜ï¼Œç¡®ä¿åœ¨ Termux èƒ½è·‘
            cd build_out
            staticx main.dist/main.bin final_app

            echo "âœ… Build finished. Verifying Security..."
            # éªŒè¯ç”Ÿæˆçš„æ˜¯ ELF äºŒè¿›åˆ¶æ–‡ä»¶
            file final_app
            ls -lh final_app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_elf
          path: build_out/final_app
