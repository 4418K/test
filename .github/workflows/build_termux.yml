name: Build for Termux (Native Docker)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_native_termux:
    runs-on: ubuntu-latest
    name: Build inside Termux Container
    steps:
      - uses: actions/checkout@v4

      # 1. å¯ç”¨ QEMUï¼Œè®© GitHub Actions èƒ½è¿è¡Œ ARM64 å®¹å™¨
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. åœ¨ Termux å®˜æ–¹é•œåƒä¸­è¿›è¡Œç¼–è¯‘
      # è¿™ä¸€æ­¥æ˜¯å…³é”®ï¼æˆ‘ä»¬åœ¨çœŸæ­£çš„ Termux ç¯å¢ƒé‡Œå¹²æ´»ï¼Œç”Ÿæˆçš„ç»å¯¹æ˜¯äº²ç”Ÿçš„
      - name: Build in Termux Docker
        run: |
          # åˆ›å»ºæ„å»ºè„šæœ¬ï¼Œè¿™å°†åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œ
          cat > build_script.sh << 'EOF'
          set -e
          
          echo "ğŸ”¥ [1/6] Setting up Termux environment..."
          # åˆ‡æ¢ Termux æº (é˜²æ­¢å®˜æ–¹æºæ…¢)
          termux-change-repo
          pkg update -y
          
          # å®‰è£…å¿…è¦çš„å·¥å…·
          # python: è¿è¡Œ nuitka
          # clang: ç¼–è¯‘ C å¯åŠ¨å™¨
          # binutils: åŒ…å« strip ç­‰å·¥å…·
          # patchelf: nuitka éœ€è¦
          pkg install -y python clang binutils patchelf make tar

          echo "ğŸ“¦ [2/6] Installing Nuitka..."
          pip install nuitka

          echo "ğŸš€ [3/6] Compiling Python to C-Extension..."
          cd /workspace
          # è‡ªåŠ¨å¯»æ‰¾ py æ–‡ä»¶
          SCRIPT_NAME=$(ls *.py | head -n 1)
          echo "Processing: $SCRIPT_NAME"
          
          # ç¼–è¯‘ä¸º standalone æ–‡ä»¶å¤¹
          # æ³¨æ„ï¼šè¿™é‡Œç”Ÿæˆçš„ .so æ–‡ä»¶æ˜¯åŸç”Ÿ Bionic æ ¼å¼çš„
          python -m nuitka --standalone --output-dir=build_out "$SCRIPT_NAME"

          echo "ğŸ”§ [4/6] Preparing Payload..."
          cd build_out
          # é‡å‘½å dist ç›®å½•
          DIST_DIR=$(ls -d *.dist | head -n 1)
          mv "$DIST_DIR" app_pkg
          
          # é‡å‘½åå…¥å£äºŒè¿›åˆ¶
          cd app_pkg
          BIN_FILE=$(ls *.bin | head -n 1)
          mv "$BIN_FILE" entrypoint
          cd ..
          
          # æ‰“åŒ…
          tar -czf payload.tar.gz app_pkg
          PAYLOAD_SIZE=$(stat -c%s payload.tar.gz)
          echo "Payload size: $PAYLOAD_SIZE"

          echo "ğŸ› ï¸ [5/6] Compiling Native C Launcher..."
          cat > launcher.c << 'C_CODE'
          #include <stdio.h>
          #include <stdlib.h>
          #include <string.h>
          #include <unistd.h>
          #include <sys/stat.h>
          #include <sys/types.h>

          #define FOOTER_SIZE 14

          int main(int argc, char *argv[]) {
              // 1. Android ç‰¹æœ‰çš„ç¯å¢ƒå˜é‡æ¸…ç†
              unsetenv("LD_PRELOAD");

              // 2. è‡ªèº«å®šä½
              FILE *self = fopen("/proc/self/exe", "rb");
              if (!self) self = fopen(argv[0], "rb");
              if (!self) return 1;

              // 3. è¯»å– Footer
              if (fseek(self, -FOOTER_SIZE, SEEK_END) != 0) return 1;
              char footer[FOOTER_SIZE + 1];
              if (fread(footer, 1, FOOTER_SIZE, self) != FOOTER_SIZE) return 1;
              if (strncmp(footer + 10, "TERM", 4) != 0) return 1;
              
              footer[10] = '\0';
              long payload_size = atol(footer);

              // 4. åˆ›å»ºä¸´æ—¶ç›®å½•
              char tmp_dir_template[] = "/data/data/com.termux/files/usr/tmp/app_XXXXXX";
              // å¦‚æœä¸åœ¨ Termux æ ‡å‡†è·¯å¾„ï¼Œå°è¯• /tmp (å®¹é”™)
              struct stat st;
              if (stat("/data/data/com.termux/files/usr/tmp", &st) == -1) {
                  strcpy(tmp_dir_template, "/tmp/app_XXXXXX");
              }
              char *tmp_path = mkdtemp(tmp_dir_template);
              if (!tmp_path) return 1;

              // 5. æå– Payload
              fseek(self, -(FOOTER_SIZE + payload_size), SEEK_END);
              char tar_path[1024];
              snprintf(tar_path, sizeof(tar_path), "%s/payload.tar.gz", tmp_path);
              FILE *out_tar = fopen(tar_path, "wb");
              
              unsigned char buffer[8192];
              long bytes_left = payload_size;
              while (bytes_left > 0) {
                  size_t to_read = (bytes_left > sizeof(buffer)) ? sizeof(buffer) : bytes_left;
                  size_t read = fread(buffer, 1, to_read, self);
                  if (read == 0) break;
                  fwrite(buffer, 1, read, out_tar);
                  bytes_left -= read;
              }
              fclose(out_tar);
              fclose(self);

              // 6. è§£å‹ (ä½¿ç”¨ -m å¿½ç•¥æ—¶é—´æˆ³)
              char cmd[2048];
              snprintf(cmd, sizeof(cmd), "tar -xf \"%s\" -C \"%s\" -m", tar_path, tmp_path);
              system(cmd);

              // 7. è¿è¡Œ
              // å…³é”®ï¼šæ˜¾å¼è®¾ç½® LD_LIBRARY_PATHï¼Œå› ä¸º Android å¿½ç•¥ RPATH
              // æˆ‘ä»¬æŒ‡å‘è§£å‹åçš„ app_pkg ç›®å½•ï¼Œé‚£é‡Œæœ‰ libpython å’Œå…¶ä»– .so
              char run_cmd[4096];
              snprintf(run_cmd, sizeof(run_cmd), 
                  "export LD_LIBRARY_PATH=\"%s/app_pkg:$LD_LIBRARY_PATH\"; "
                  "\"%s/app_pkg/entrypoint\" ", 
                  tmp_path, tmp_path);
              
              for (int i = 1; i < argc; i++) {
                  strcat(run_cmd, " \"");
                  strcat(run_cmd, argv[i]);
                  strcat(run_cmd, "\"");
              }
              
              int ret = system(run_cmd);

              // 8. æ¸…ç†
              snprintf(cmd, sizeof(cmd), "rm -rf \"%s\"", tmp_path);
              system(cmd);

              return WEXITSTATUS(ret);
          }
          C_CODE

          # ä½¿ç”¨ Termux çš„ Clang ç¼–è¯‘
          # è¿™æ ·ç”Ÿæˆçš„ final_app å°±æ˜¯åŸç”Ÿçš„ Android ELF æ–‡ä»¶ï¼
          clang -O2 -o final_app launcher.c
          strip final_app

          echo "ğŸ”— [6/6] Attaching Payload..."
          cat payload.tar.gz >> final_app
          printf "%010dTERM" $PAYLOAD_SIZE >> final_app
          
          mv final_app /workspace/final_app_native
          echo "âœ… Success!"
          EOF

          chmod +x build_script.sh

          # å¯åŠ¨ Termux å®¹å™¨å¹¶è¿è¡Œä¸Šé¢çš„è„šæœ¬
          # ä½¿ç”¨ termux/termux-docker:aarch64 é•œåƒ
          docker run --rm \
            --platform linux/arm64 \
            -v "$PWD:/workspace" \
            termux/termux-docker:aarch64 \
            /bin/bash /workspace/build_script.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_native_elf
          path: final_app_native
