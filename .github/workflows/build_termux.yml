name: Build for Android Termux (Static Musl)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-static-binary:
    runs-on: ubuntu-latest
    name: Build Static ELF on Alpine
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Build in QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          # 挂载根目录
          run: |
            echo "--- 1. 安装静态编译依赖 ---"
            apk update
            # 关键修改：安装 python3-static 用于静态链接
            apk add python3 python3-dev py3-pip build-base patchelf python3-static libffi-dev openssl-dev zlib-dev zlib-static
            
            echo "--- 2. 安装 Nuitka ---"
            pip3 install nuitka --break-system-packages

            echo "--- 3. 配置静态编译参数 ---"
            # 强制 GCC 进行静态链接
            export LDFLAGS="-static"
            # 告诉 Nuitka 使用静态 Python 库
            export NUITKA_FLAGS="--static-libpython=yes"

            echo "--- 4. 开始静态编译 ---"
            # 注意：这里假设 A_Main_new.py 在仓库根目录
            python3 -m nuitka --standalone --onefile $NUITKA_FLAGS --output-dir=dist --output-filename=paktool pppppp.py
            
            echo "--- 5. 验证文件类型 ---"
            # 如果成功，file 命令应该显示 "statically linked"
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-static-aarch64
          path: dist/paktool
          compression-level: 9
