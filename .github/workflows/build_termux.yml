name: Build Termux (Native Fix)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-termux-fixed:
    runs-on: ubuntu-latest
    name: Build Native Termux (Fixed Repos)
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Build in Termux Container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: none
          # 依然使用官方镜像，但我们在下面手动修复它
          base_image: termux/termux-docker:aarch64
          githubToken: ${{ github.token }}
          
          run: |
            echo "--- 1. 修复已失效的源地址 ---"
            # 定义 Termux 的系统路径变量
            export PREFIX=/data/data/com.termux/files/usr
            
            # 强制将源列表替换为官方最新的 packages.termux.dev
            echo "deb https://packages.termux.dev/apt/termux-main stable main" > $PREFIX/etc/apt/sources.list
            
            # 删除可能导致报错的旧版源配置文件
            rm -rf $PREFIX/etc/apt/sources.list.d/*
            
            echo "--- 2. 更新系统并安装依赖 ---"
            # 更新列表
            apt-get update
            
            # 先安装 keyring 防止签名报错，然后升级系统
            apt-get install -y termux-keyring
            # 这里的 -o Dpkg::Options::="--force-confnew" 是为了防止更新时询问配置文件
            apt-get upgrade -y -o Dpkg::Options::="--force-confnew"
            
            # 安装编译所需的包
            # python: Python 环境
            # clang: 编译器
            # make, binutils: 编译工具
            # patchelf: Nuitka 必备
            # libffi-dev: Python 库常用依赖
            apt-get install -y python clang make binutils git patchelf libffi-dev
            
            echo "--- 3. 安装 Nuitka ---"
            pip install --upgrade pip
            pip install nuitka
            
            # 如果你的代码需要第三方库，请在这里安装，例如：
            # pip install requests
            
            mkdir -p /.cache/Nuitka
            chmod -R 777 /.cache

            echo "--- 4. 开始编译 ---"
            # 使用 Termux 原生环境编译
            python -m nuitka \
              --standalone \
              --onefile \
              --jobs=1 \
              --output-dir=dist \
              --output-filename=paktool \
              pppppp.py
            
            echo "--- 5. 验证 ---"
            ls -lh dist/paktool
            echo "Success!"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-fixed
          path: dist/paktool
          compression-level: 0
