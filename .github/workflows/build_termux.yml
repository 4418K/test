name: Build for Termux (Aarch64 Musl)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_musl:
    runs-on: ubuntu-latest
    name: Build Nuitka on Alpine (aarch64)
    steps:
      # 1. æ›´æ–° checkout åˆ° v4
      - uses: actions/checkout@v4

      # 2. ä½¿ç”¨ QEMU æ¨¡æ‹Ÿ Aarch64 ç¯å¢ƒè¿è¡Œ Alpine Linux
      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          
          githubToken: ${{ github.token }}
          
          # åœ¨ Alpine å®¹å™¨å†…éƒ¨è¿è¡Œçš„å‘½ä»¤
          run: |
            echo "ğŸ”¥ Installing dependencies..."
            # æ›´æ–°æºå¹¶å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
            apk update
            # æ·»åŠ  --no-cache å‡å°é•œåƒä½“ç§¯
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev libffi-dev openssl-dev make build-base ccache patchelf file

            echo "ğŸ“¦ Installing Nuitka..."
            # Alpine çš„ Python ç¯å¢ƒç”±ç³»ç»Ÿç®¡ç†ï¼Œéœ€è¦ç”¨ --break-system-packages
            pip3 install nuitka --break-system-packages
            
            # å¦‚æœä½ æœ‰ requirements.txtï¼Œå–æ¶ˆä¸‹é¢ä¸¤è¡Œçš„æ³¨é‡Šï¼š
            # pip3 install -r requirements.txt --break-system-packages

            echo "ğŸš€ Compiling with Nuitka..."
            # ç¼–è¯‘å‘½ä»¤
            # --static-libpython=no: åœ¨ Alpine ä¸Šé€šå¸¸ä¸å»ºè®®å¼ºåˆ¶é™æ€é“¾æ¥ libpythonï¼Œ
            # å› ä¸º Alpine çš„åŠ¨æ€åº“æœ¬èº«å°±æ˜¯é’ˆå¯¹ Musl ä¼˜åŒ–çš„ï¼Œstandalone æ¨¡å¼ä¼šè‡ªåŠ¨æ‰“åŒ…éœ€è¦çš„åº“ã€‚
            python3 -m nuitka --standalone --onefile --output-dir=build_out main.py

            echo "âœ… Build finished. Checking file info:"
            ls -lh build_out/
            file build_out/main.bin || true

      # 3. ä¿®å¤æŠ¥é”™çš„å…³é”®ï¼šå‡çº§ upload-artifact åˆ° v4
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_executable
          path: build_out/*.bin
          # v4 ç‰ˆæœ¬é»˜è®¤ä¸å‹ç¼©ï¼ˆæˆ–è€…å‹ç¼©æ–¹å¼æ”¹å˜ï¼‰ï¼Œä¸Šä¼ é€Ÿåº¦æ›´å¿«
