name: Build Termux (StaticX)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-staticx:
    runs-on: ubuntu-latest
    name: Build Static Executable
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build in Alpine Container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          # 使用 Python 3.11 Alpine 镜像，兼容性最好
          base_image: python:3.11-alpine
          githubToken: ${{ github.token }}
          
          run: |
            echo "--- 1. 安装编译工具 ---"
            # 安装 gcc (build-base), patchelf (Nuitka需要), scons (StaticX需要)
            apk update
            apk add build-base patchelf scons git libffi-dev zlib-dev openssl-dev
            
            echo "--- 2. 安装 Python 库 ---"
            pip install --upgrade pip
            # 安装 Nuitka 和 StaticX
            pip install nuitka staticx
            
            # 如果你的脚本有依赖（如 requests），请在这里安装
            # pip install requests

            echo "--- 3. Nuitka 编译 (阶段1) ---"
            # 先用 Nuitka 编译成依赖 musl 的普通可执行文件
            # 注意：这里我们不需要 --static-libpython=yes，避免之前的报错
            python -m nuitka \
              --standalone \
              --onefile \
              --jobs=1 \
              --output-dir=dist \
              --output-filename=paktool-temp \
              pppppp.py
            
            echo "--- 4. StaticX 打包 (阶段2) ---"
            # 这一步是核心！将 Nuitka 生成的文件打包成全静态文件
            # 这样它就不再依赖 /lib/ld-musl-aarch64.so.1 了
            staticx dist/paktool-temp dist/paktool
            
            echo "--- 5. 验证 ---"
            ls -lh dist/paktool
            # 验证文件类型，此时它应该是静态链接的
            apk add file
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-static
          path: dist/paktool
          compression-level: 0
