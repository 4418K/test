name: Build Termux (Stable & Low Memory)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-stable-binary:
    runs-on: ubuntu-latest
    name: Build on Ubuntu 24.04 (Safe Mode)
    # 设置超时时间，防止单核编译卡死太久
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 使用 Ubuntu 24.04 (自带 Python 3.12, 支持你的代码语法)
      - name: Run Build in QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu24.04
          githubToken: ${{ github.token }}
          
          # 挂载根目录
          run: |
            echo "--- 1. 准备环境 ---"
            apt-get update
            # 安装基础依赖
            apt-get install -y python3 python3-pip python3-dev build-essential patchelf git
            
            echo "--- 2. 安装 Nuitka ---"
            # 24.04 必须加这个参数
            pip3 install nuitka --break-system-packages
            
            # 给予缓存权限
            mkdir -p /.cache/Nuitka
            chmod -R 777 /.cache

            echo "--- 3. 开始防崩溃编译 ---"
            echo "⚠️ 正在使用单线程模式以防止内存溢出，请耐心等待..."
            
            # 关键参数解释：
            # --jobs=1 : 只用1个CPU核心，防止内存撑爆 (关键!)
            # --lto=no : 关闭链接优化，大幅降低内存消耗 (关键!)
            # pppppp.py : 你的源代码文件名
            
            python3 -m nuitka \
              --standalone \
              --onefile \
              --jobs=1 \
              --lto=no \
              --output-dir=dist \
              --output-filename=paktool \
              pppppp.py
            
            echo "--- 4. 验证 ---"
            ls -lh dist/paktool
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-final
          path: dist/paktool
          compression-level: 0
