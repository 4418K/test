name: Build for Termux (Aarch64 Static)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_static:
    runs-on: ubuntu-latest
    name: Build Static Nuitka on Alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          # è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼šé…ç½®å…¨é™æ€ç¼–è¯‘ç¯å¢ƒ
          run: |
            echo "ğŸ”¥ Installing system dependencies..."
            apk update
            # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
            # å…³é”®ï¼šå¿…é¡»å®‰è£… zlib-static å’Œ openssl-libs-staticï¼Œå¦åˆ™é™æ€é“¾æ¥ä¼šæŠ¥é”™
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev libffi-dev make build-base ccache patchelf file zlib-static openssl-libs-static openssl-dev

            echo "ğŸ“¦ Installing Nuitka..."
            pip3 install nuitka --break-system-packages
            
            # å¦‚æœä½ æœ‰ä¾èµ–ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Š (æ³¨æ„ï¼šæœ‰äº›åº“å¦‚ numpy å¾ˆéš¾é™æ€ç¼–è¯‘)
            # pip3 install -r requirements.txt --break-system-packages

            echo "ğŸš€ Compiling with Nuitka (Static Mode)..."
            
            # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶ GCC è¿›è¡Œé™æ€é“¾æ¥
            # è¿™æ · musl libc å°±ä¼šè¢«æ‰“åŒ…è¿› exeï¼Œè€Œä¸ä¼šåœ¨è¿è¡Œæ—¶å¯»æ‰¾ .so æ–‡ä»¶
            export LDFLAGS="-static"
            
            # Nuitka å‘½ä»¤ä¿®æ”¹ï¼š
            # --static-libpython=yes : æŠŠ Python è§£é‡Šå™¨é™æ€æ‰“åŒ…
            # --disable-ccache : åœ¨ GitHub Actions é‡Œæœ‰æ—¶å€™ ccache ä¼šå¹²æ‰°é™æ€é“¾æ¥ï¼Œå»ºè®®å…³é—­
            python3 -m nuitka --standalone --onefile \
              --static-libpython=yes \
              --disable-ccache \
              --output-dir=build_out \
              main.py

            echo "âœ… Build finished. Checking binary type..."
            # è¿™é‡Œçš„ grep æ£€æŸ¥å¾ˆé‡è¦ï¼Œå¿…é¡»æ˜¾ç¤º "statically linked" æ‰ç®—æˆåŠŸ
            file build_out/main.bin
            if file build_out/main.bin | grep -q "statically linked"; then
              echo "ğŸ‰ SUCCESS: Binary is statically linked!"
            else
              echo "âš ï¸ WARNING: Binary is still dynamically linked!"
            fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_static_executable
          path: build_out/*.bin
