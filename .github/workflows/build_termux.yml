name: Build Termux (Final Robust)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-termux-final-v2:
    runs-on: ubuntu-latest
    name: Build ARM64 Static Binary
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          FROM python:3.11-alpine
          
          # 1. 安装环境
          RUN apk add --no-cache build-base git patchelf scons libffi-dev zlib-dev openssl-dev
          RUN pip install --upgrade pip
          RUN pip install nuitka staticx
          
          WORKDIR /app
          COPY pppppp.py .
          
          # 2. Nuitka 编译 (不指定 filename，使用默认 pppppp)
          # 这样输出目录一定是 build/pppppp.dist/pppppp
          RUN python -m nuitka \
              --standalone \
              --lto=no \
              --output-dir=build \
              pppppp.py
          
          # 3. 【关键步骤】列出文件结构，防止路径猜错
          RUN echo "--- Debug: List all files in build directory ---" && ls -R build
          
          # 4. StaticX 打包
          # 我们使用 find 命令自动查找 build 目录下的可执行文件，避免路径写死错误
          # -type f: 找文件
          # -perm +0111: 找可执行文件 (二进制)
          # ! -name "*.so": 排除库文件
          RUN TARGET_BIN=\$(find build -type f -name "pppppp") && \
              echo "Found target binary at: \$TARGET_BIN" && \
              staticx \$TARGET_BIN /app/paktool
          
          # 5. 验证
          RUN apk add file && file /app/paktool
          EOF

      - name: Build and Export
        run: |
          echo "--- Building for ARM64 ---"
          # 强制指定平台 linux/arm64
          docker buildx build --platform linux/arm64 -t termux-builder --load .
          
          echo "--- Extracting Artifact ---"
          docker create --name dummy termux-builder
          docker cp dummy:/app/paktool ./paktool
          docker rm dummy
          
          echo "--- Fixing Permissions ---"
          sudo chown $USER:$USER ./paktool
          chmod +x ./paktool
          
          ls -lh ./paktool
          file ./paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-arm64
          path: paktool
          compression-level: 0
