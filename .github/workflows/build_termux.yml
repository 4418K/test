name: Build for Termux (Final V4 - Loader Fix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_loader_fix:
    runs-on: ubuntu-latest
    name: Build ELF with Bundled Loader
    steps:
      - uses: actions/checkout@v4

      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          run: |
            echo "ğŸ”¥ 1. Installing dependencies..."
            apk update
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev make build-base tar patchelf coreutils

            echo "ğŸ“¦ 2. Installing Nuitka..."
            pip3 install nuitka --break-system-packages

            echo "ğŸš€ 3. Nuitka Compilation..."
            SCRIPT_NAME=$(find . -maxdepth 1 -name "*.py" | head -n 1)
            python3 -m nuitka --standalone --output-dir=build_out "$SCRIPT_NAME"

            echo "ğŸ”§ 4. Packaging & Bundling Loader..."
            cd build_out
            DIST_DIR=$(find . -maxdepth 1 -type d -name "*.dist" | head -n 1)
            mv "$DIST_DIR" app_pkg
            
            cd app_pkg
            BIN_FILE=$(find . -maxdepth 1 -type f -name "*.bin" | head -n 1)
            mv "$BIN_FILE" entrypoint
            
            # ã€å…³é”®æ­¥éª¤ 1ã€‘æŠŠ Alpine ç³»ç»Ÿçš„åŠ¨æ€åŠ è½½å™¨(ld-musl) å·å‡ºæ¥ï¼Œæ‰“åŒ…è¿›ç¨‹åº
            # è¿™æ ·æˆ‘ä»¬åœ¨ Android ä¸Šå°±èƒ½ç”¨å®ƒæ¥è§£é‡Šè¿è¡Œ musl çš„ç¨‹åºäº†
            cp /lib/libc.musl-aarch64.so.1 ./ld-musl.so
            chmod +x ./ld-musl.so
            echo "Bundled ld-musl.so successfully."
            cd ..

            echo "ğŸ“¦ 5. Packing Payload..."
            tar --exclude='__pycache__' -czf payload.tar.gz app_pkg
            PAYLOAD_SIZE=$(stat -c%s payload.tar.gz)
            echo "Payload Size: $PAYLOAD_SIZE bytes"

            echo "ğŸ› ï¸ 6. Creating C Launcher (Loader Strategy)..."
            cat > launcher.c << 'EOF'
            #include <stdio.h>
            #include <stdlib.h>
            #include <string.h>
            #include <unistd.h>
            #include <sys/stat.h>
            #include <sys/types.h>

            #define FOOTER_SIZE 14

            int main(int argc, char *argv[]) {
                // 1. æ¸…é™¤ LD_PRELOAD (é˜²æ­¢ Termux Hook å¹²æ‰°)
                unsetenv("LD_PRELOAD");
                
                // 2. æ³¨æ„ï¼šç»å¯¹ä¸è¦åœ¨è¿™é‡Œå…¨å±€è®¾ç½® LD_LIBRARY_PATH
                // å¦åˆ™ä¼šå¯¼è‡´åé¢çš„ rm, tar ç­‰ç³»ç»Ÿå‘½ä»¤å´©æºƒ

                FILE *self = fopen("/proc/self/exe", "rb");
                if (!self) self = fopen(argv[0], "rb");
                if (!self) return 1;

                if (fseek(self, -FOOTER_SIZE, SEEK_END) != 0) { fclose(self); return 1; }
                char footer[FOOTER_SIZE + 1];
                if (fread(footer, 1, FOOTER_SIZE, self) != FOOTER_SIZE) { fclose(self); return 1; }
                if (strncmp(footer + 10, "TERM", 4) != 0) { fclose(self); return 1; }
                
                footer[10] = '\0';
                long payload_size = atol(footer);
                
                char tmp_dir_template[] = "/data/data/com.termux/files/usr/tmp/app_XXXXXX";
                struct stat st;
                if (stat("/data/data/com.termux/files/usr/tmp", &st) == -1) {
                    strcpy(tmp_dir_template, "/tmp/app_XXXXXX");
                }
                char *tmp_path = mkdtemp(tmp_dir_template);
                if (!tmp_path) return 1;

                fseek(self, -(FOOTER_SIZE + payload_size), SEEK_END);
                char tar_path[1024];
                snprintf(tar_path, sizeof(tar_path), "%s/payload.tar.gz", tmp_path);
                FILE *out_tar = fopen(tar_path, "wb");
                
                unsigned char buffer[8192];
                long bytes_left = payload_size;
                while (bytes_left > 0) {
                    size_t to_read = (bytes_left > sizeof(buffer)) ? sizeof(buffer) : bytes_left;
                    size_t read = fread(buffer, 1, to_read, self);
                    if (read == 0) break;
                    fwrite(buffer, 1, read, out_tar);
                    bytes_left -= read;
                }
                fclose(out_tar);
                fclose(self);

                // è§£å‹ (åŠ ä¸Š -m å¿½ç•¥æ—¶é—´æˆ³)
                char cmd[2048];
                snprintf(cmd, sizeof(cmd), "tar -xf \"%s\" -C \"%s\" -m", tar_path, tmp_path);
                system(cmd);

                // ã€å…³é”®æ­¥éª¤ 2ã€‘æ„å»ºå¯åŠ¨å‘½ä»¤
                // æ ¼å¼ï¼šLD_LIBRARY_PATH=...  ./ld-musl.so  ./entrypoint  args...
                // æˆ‘ä»¬æ˜¾å¼è°ƒç”¨æ‰“åŒ…è¿›å»çš„ ld-musl.so æ¥è¿è¡Œç¨‹åºï¼Œç»•è¿‡ Android ç³»ç»ŸåŠ è½½å™¨
                
                char run_cmd[8192];
                // æ‹¼æ¥ LD_LIBRARY_PATH ç¯å¢ƒå˜é‡ (åªå¯¹è¿™è¡Œå‘½ä»¤æœ‰æ•ˆ)
                // å¿…é¡»åŒ…å« app_pkg ç›®å½•ï¼Œè¿™æ ·æ‰èƒ½æ‰¾åˆ° libpython ç­‰ä¾èµ–
                snprintf(run_cmd, sizeof(run_cmd), 
                    "LD_LIBRARY_PATH=\"%s/app_pkg:$LD_LIBRARY_PATH\" "
                    "\"%s/app_pkg/ld-musl.so\" "
                    "\"%s/app_pkg/entrypoint\"", 
                    tmp_path, tmp_path, tmp_path);
                
                // æ‹¼æ¥å‚æ•°
                for (int i = 1; i < argc; i++) {
                    strcat(run_cmd, " \"");
                    strcat(run_cmd, argv[i]);
                    strcat(run_cmd, "\"");
                }
                
                // æ‰§è¡Œ
                int ret = system(run_cmd);

                // æ¸…ç†
                snprintf(cmd, sizeof(cmd), "rm -rf \"%s\"", tmp_path);
                system(cmd);

                return WEXITSTATUS(ret);
            }
            EOF

            echo "ğŸ”¨ 7. Compiling Launcher..."
            gcc -static -O2 -o final_app launcher.c
            strip final_app

            echo "ğŸ”— 8. Attaching Payload..."
            cat payload.tar.gz >> final_app
            printf "%010dTERM" $PAYLOAD_SIZE >> final_app

            echo "âœ… Build finished."
            ls -lh final_app
            file final_app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_elf_final_v4
          path: build_out/final_app
