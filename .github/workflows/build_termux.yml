name: Build for Termux (Aarch64 Musl)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_musl:
    runs-on: ubuntu-latest
    name: Build Nuitka on Alpine (aarch64)
    steps:
      - uses: actions/checkout@v3

      # è¿™é‡Œä½¿ç”¨äº† uraimo/run-on-arch-action
      # å®ƒä¼šè‡ªåŠ¨é…ç½® QEMU æ¨¡æ‹Ÿå™¨å¹¶æ‹‰å– aarch64 çš„é•œåƒ
      # æˆ‘ä»¬é€‰æ‹© alpineï¼Œå› ä¸ºå®ƒæ˜¯åŸºäº MUSL çš„ï¼Œç¬¦åˆä½ çš„ zig target è¦æ±‚
      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          
          # å¹¶ä¸æ˜¯ç›´æ¥æŠŠæ–‡ä»¶æ˜ å°„è¿›å»ï¼Œè€Œæ˜¯æŠŠ workspace æŒ‚è½½è¿›å»
          githubToken: ${{ github.token }}
          
          # åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œçš„å‘½ä»¤
          run: |
            echo "ğŸ”¥ Installing dependencies..."
            apk update
            # å®‰è£… Python3, GCC, Musl å¼€å‘åº“, Ccache, Patchelf
            apk add python3 python3-dev py3-pip gcc musl-dev libffi-dev openssl-dev make build-base ccache patchelf

            echo "ğŸ“¦ Installing Nuitka..."
            # è¿™é‡Œçš„ --break-system-packages æ˜¯å› ä¸º Alpine æ–°ç‰ˆ Python çš„ä¿æŠ¤æœºåˆ¶
            pip3 install nuitka --break-system-packages
            
            # å¦‚æœä½ æœ‰ç¬¬ä¸‰æ–¹åº“ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šå¹¶å®‰è£…
            # pip3 install -r requirements.txt --break-system-packages

            echo "ğŸš€ Compiling with Nuitka..."
            # --static-libpython: é™æ€é“¾æ¥ Python åº“ï¼ˆå…³é”®ï¼ï¼‰
            # --standalone: ç‹¬ç«‹è¿è¡Œ
            # --onefile: å•æ–‡ä»¶
            python3 -m nuitka --standalone --onefile --static-libpython=no --output-dir=build_out main.py

            echo "âœ… Build finished. Checking file type..."
            file build_out/main.bin || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: termux_aarch64_executable
          path: build_out/*.bin
