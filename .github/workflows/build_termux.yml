name: Build in Termux Environment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_termux_native:
    runs-on: ubuntu-latest
    name: Build using Termux Docker
    steps:
      - uses: actions/checkout@v4

      - name: Build in Termux Container
        run: |
          # 1. æ‹‰å– Termux å®˜æ–¹ Docker é•œåƒ
          # è¿™ä¸ªé•œåƒå†…éƒ¨æ˜¯çœŸæ­£çš„ Termux ç¯å¢ƒ (Bionic libc)
          docker pull ghcr.io/termux/termux-docker:latest

          # 2. åˆ›å»ºæ„å»ºè„šæœ¬
          cat > build_inside.sh << 'EOF'
          #!/data/data/com.termux/files/usr/bin/bash
          set -e

          echo "ğŸ”§ Setting up Termux environment..."
          # æ›´æ–°åŒ…
          apt update
          apt upgrade -y

          # å®‰è£…ç¼–è¯‘å·¥å…·
          apt install -y python clang binutils patchelf make

          echo "ğŸ“¦ Installing Nuitka..."
          pip install nuitka

          echo "ğŸš€ Compiling..."
          cd /work
          # æ‰¾åˆ° py æ–‡ä»¶
          SCRIPT=$(ls *.py | head -n 1)
          echo "Found script: $SCRIPT"

          # ç¼–è¯‘ (standalone æ¨¡å¼)
          python -m nuitka --standalone --output-dir=build_out "$SCRIPT"

          # æ•´ç†è¾“å‡º
          cd build_out
          DIST_DIR=$(ls -d *.dist | head -n 1)
          mv "$DIST_DIR" app_pkg
          
          cd app_pkg
          BIN_FILE=$(ls *.bin 2>/dev/null | head -n 1)
          if [ -n "$BIN_FILE" ]; then
            mv "$BIN_FILE" final_app
          fi

          echo "âœ… Build complete!"
          ls -la
          EOF

          chmod +x build_inside.sh

          # 3. åœ¨ Termux å®¹å™¨ä¸­è¿è¡Œæ„å»º
          docker run --rm \
            -v "$PWD:/work" \
            -v "$PWD/build_inside.sh:/build_inside.sh" \
            ghcr.io/termux/termux-docker:latest \
            /data/data/com.termux/files/usr/bin/bash /build_inside.sh

          # 4. æ‰“åŒ…ç»“æœ
          cd build_out/app_pkg
          tar -czf ../../termux_app.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_native_build
          path: termux_app.tar.gz
