name: Build Termux Static ELF (Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-static-stable:
    runs-on: ubuntu-latest
    name: Build Static Python (Single Thread)
    # 设置超时防止卡死
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Build in QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          # 挂载根目录
          run: |
            echo "--- 1. 安装编译工具 ---"
            apk update
            apk add build-base git patchelf libffi-dev zlib-dev openssl-dev linux-headers curl
            
            echo "--- 2. 下载 Python 3.10 源码 ---"
            cd /tmp
            curl -O https://www.python.org/ftp/python/3.10.13/Python-3.10.13.tgz
            tar xzf Python-3.10.13.tgz
            cd Python-3.10.13
            
            echo "--- 3. 配置编译参数 ---"
            # --disable-shared: 生成静态库 (.a)
            # --without-ensurepip: 暂时不装pip，后面单独装，减少出错概率
            ./configure \
                --prefix=/usr/local \
                --disable-shared \
                --enable-ipv6 \
                --with-lto=no
            
            echo "--- 4. 编译 Python (关键一步) ---"
            echo "⚠️ 注意：为了防止 QEMU 崩溃，这里强制使用单线程编译 (make -j1)"
            echo "⚠️ 这将花费较长时间 (约15-25分钟)，请耐心等待..."
            
            # 关键修改：去掉 -j$(nproc)，只用 -j1
            make -j1
            make install
            
            # 回到项目目录
            cd $GITHUB_WORKSPACE
            
            echo "--- 5. 安装 Nuitka ---"
            # 此时 /usr/local/bin/python3 已经是我们刚编译的版本
            /usr/local/bin/python3 -m ensurepip
            /usr/local/bin/python3 -m pip install nuitka --no-cache-dir

            echo "--- 6. 开始 Nuitka 静态打包 ---"
            export LDFLAGS="-static"
            
            # 同样，Nuitka 也要限制并行数，防止链接时崩溃
            /usr/local/bin/python3 -m nuitka \
              --standalone \
              --onefile \
              --static-libpython=yes \
              --lto=no \
              --jobs=1 \
              --output-dir=dist \
              --output-filename=paktool \
              pppppp.py
            
            echo "--- 7. 验证 ---"
            ls -lh dist/paktool
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-static-aarch64
          path: dist/paktool
          compression-level: 0
