name: Build Termux (Native)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-termux-native:
    runs-on: ubuntu-latest
    name: Build Native Termux
    timeout-minutes: 60
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Build in Termux Container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: none
          # 使用官方 Termux 镜像，环境与你手机完全一致
          base_image: termux/termux-docker:aarch64
          githubToken: ${{ github.token }}
          
          # 挂载当前目录到容器内
          install: |
            # 这里的 install 步骤在 Termux 镜像里可能不适用，留空，直接在 run 里写
          
          run: |
            echo "--- 1. 更新源并安装依赖 ---"
            # Termux 容器使用 apt/pkg
            apt-get update
            
            # 安装核心编译工具
            # python: 包含 python3 和 pip
            # clang: Termux 的编译器
            # make, binutils: 编译辅助
            # patchelf: Nuitka 需要
            # git: 常用工具
            apt-get install -y python clang make binutils git patchelf libffi-dev
            
            echo "--- 2. 安装 Nuitka ---"
            # 升级 pip 并安装 nuitka
            pip install --upgrade pip
            pip install nuitka
            
            # 如果你的脚本有依赖 (如 requests)，请在这里安装
            # pip install requests
            
            mkdir -p /.cache/Nuitka
            chmod -R 777 /.cache

            echo "--- 3. 开始编译 ---"
            # 注意：不再需要 --static-libpython=yes
            # 因为我们是在 Termux 原生环境编译，动态链接也是链接到 Android 的库，完全没问题
            python -m nuitka \
              --standalone \
              --onefile \
              --jobs=1 \
              --output-dir=dist \
              --output-filename=paktool \
              pppppp.py
            
            echo "--- 4. 验证 ---"
            ls -lh dist/paktool
            echo "Build finished!"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-native
          path: dist/paktool
          compression-level: 0
