name: Build Termux (Glibc + gcompat)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.py'

jobs:
  build-glibc-binary:
    runs-on: ubuntu-latest
    name: Build Standard ELF (Ubuntu)
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 改用 Ubuntu 环境，这里的软件源非常稳，不会像 Alpine 那样缺包或需要编译
      - name: Run Build in QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu20.04  # 使用 Ubuntu 而不是 Alpine
          githubToken: ${{ github.token }}
          
          run: |
            echo "--- 1. 更新源并安装依赖 ---"
            # 这里的 apt 安装非常稳定
            apt-get update
            apt-get install -y python3 python3-pip python3-dev build-essential patchelf git
            
            echo "--- 2. 安装 Nuitka ---"
            # Ubuntu 下 pip 安装通常有现成的 wheel，速度快且不崩
            pip3 install nuitka --break-system-packages
            
            # 修正 Nuitka 缓存目录权限 (防止偶尔的权限报错)
            mkdir -p /.cache/Nuitka
            chmod -R 777 /.cache

            echo "--- 3. 开始编译 ---"
            # 生成标准的 Linux 可执行文件
            python3 -m nuitka \
              --standalone \
              --onefile \
              --output-dir=dist \
              --output-filename=paktool \
              A_Main_new.py
            
            echo "--- 4. 验证 ---"
            ls -lh dist/paktool
            file dist/paktool

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: paktool-termux-glibc
          path: dist/paktool
          compression-level: 9
