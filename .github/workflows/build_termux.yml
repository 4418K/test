name: Build for Termux (StaticX)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_android_staticx:
    runs-on: ubuntu-latest
    name: Build with StaticX on Alpine
    steps:
      - uses: actions/checkout@v4

      - name: Build inside Aarch64 Alpine container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: alpine_latest
          githubToken: ${{ github.token }}
          
          run: |
            echo "ğŸ”¥ Installing dependencies..."
            apk update
            # å®‰è£… StaticX éœ€è¦çš„æ„å»ºå·¥å…·ï¼šscons, gcc, musl-dev
            apk add --no-cache python3 python3-dev py3-pip gcc musl-dev libffi-dev make build-base patchelf scons

            echo "ğŸ“¦ Installing Nuitka and StaticX..."
            # å¿…é¡»å®‰è£… staticx
            pip3 install nuitka staticx --break-system-packages

            echo "ğŸš€ 1. Compiling with Nuitka (Standalone Mode)..."
            # æ³¨æ„ï¼š
            # 1. ä¸è¦ç”¨ --onefileï¼Œæ”¹ç”¨ --standalone (ç”Ÿæˆ dist æ–‡ä»¶å¤¹)
            # 2. ä¸è¦ç”¨ LDFLAGS="-static"ï¼Œæˆ‘ä»¬è¦åŠ¨æ€é“¾æ¥
            # 3. è¿™é‡Œçš„ main.py è¯·æ›¿æ¢ä¸ºä½ çš„çœŸå®æ–‡ä»¶å
            python3 -m nuitka --standalone --output-dir=build_out pppppp.py

            echo "ğŸ”® 2. Wrapping with StaticX..."
            # StaticX ä¼šè‡ªåŠ¨å¯»æ‰¾ç¼ºå°‘çš„ musl åº“å¹¶æ‰“åŒ…è¿›å»
            # build_out/main.dist/main.bin æ˜¯ Nuitka ç”Ÿæˆçš„ä¸»ç¨‹åº
            # build_out/final_app æ˜¯æœ€ç»ˆç”Ÿæˆçš„å•æ–‡ä»¶
            
            cd build_out
            staticx main.dist/main.bin final_app

            echo "âœ… Build finished."
            ls -lh final_app
            file final_app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: termux_aarch64_staticx
          path: build_out/final_app
